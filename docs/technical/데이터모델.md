# LinkToss - 데이터 모델 설계서

## 📌 문서 정보
- **버전**: 1.0
- **최종 수정일**: 2025-10-10
- **작성자**: Engineering Team
- **상태**: Draft

## 목차
1. [개요](#1-개요)
2. [ERD (Entity Relationship Diagram)](#2-erd-entity-relationship-diagram)
3. [테이블 명세](#3-테이블-명세)
4. [인덱스 전략](#4-인덱스-전략)
5. [데이터 제약사항](#5-데이터-제약사항)

---

## 1. 개요

### 1.1 데이터베이스 선택
- **Primary DB**: PostgreSQL 15+
  - 이유: ACID 트랜잭션, JSON 지원, 확장성, 오픈소스
- **Cache**: Redis
  - 이유: 세션 관리, 자주 조회되는 데이터 캐싱

### 1.2 네이밍 컨벤션
- 테이블명: snake_case, 복수형 (users, repositories)
- 컬럼명: snake_case
- Primary Key: id (UUID)
- Foreign Key: {테이블명}_id (user_id, repository_id)
- 타임스탬프: created_at, updated_at

### 1.3 공통 컬럼
모든 테이블에 포함:
- `id`: UUID PRIMARY KEY
- `created_at`: TIMESTAMP WITH TIME ZONE
- `updated_at`: TIMESTAMP WITH TIME ZONE
- `deleted_at`: TIMESTAMP WITH TIME ZONE (Soft Delete)

---

## 2. ERD (Entity Relationship Diagram)

```
┌─────────────────┐
│     users       │
├─────────────────┤
│ id (PK)         │
│ email           │
│ username        │
│ name            │
│ avatar_url      │
│ bio             │
│ email_verified  │
└────────┬────────┘
         │
         │ 1:N (owner)
         │
┌────────▼────────────────┐              ┌──────────────────────┐
│    repositories         │◄──────N:M────│ repository_members   │
├─────────────────────────┤              ├──────────────────────┤
│ id (PK)                 │              │ id (PK)              │
│ user_id (FK) [owner]    │              │ repository_id (FK)   │
│ parent_id (FK, nullable)│◄─────┐       │ user_id (FK)         │
│ name                    │      │       │ role (owner/editor)  │
│ description             │      │       │ invited_at           │
│ icon                    │      │       │ accepted_at          │
│ is_public               │      │       └──────────────────────┘
│ slug                    │      │ Self-referencing
│ position                │──────┘ (Sub-repository)
└────────┬────────────────┘
         │
         │ 1:N
         │
┌────────▼────────────────┐
│     documents           │
├─────────────────────────┤
│ id (PK)                 │
│ repository_id (FK)      │
│ user_id (FK)            │
│ title                   │
│ url                     │
│ content (markdown)      │
│ link_metadata (JSON)    │
│ position                │
└────────┬────────────────┘
         │
         │ N:M
         │
┌────────▼────────────────┐         ┌─────────────────┐
│   document_tags         │    N:M  │      tags       │
├─────────────────────────┤◄────────┤─────────────────┤
│ id (PK)                 │         │ id (PK)         │
│ document_id (FK)        │         │ name            │
│ tag_id (FK)             │         │ color           │
└─────────────────────────┘         │ user_id (FK)    │
                                    └─────────────────┘

┌─────────────────────────┐
│     oauth_accounts      │
├─────────────────────────┤
│ id (PK)                 │
│ user_id (FK)            │
│ provider                │
│ provider_account_id     │
│ access_token            │
│ refresh_token           │
└─────────────────────────┘

┌─────────────────────────┐
│   repository_shares     │
├─────────────────────────┤
│ id (PK)                 │
│ repository_id (FK)      │
│ share_token             │
│ view_count              │
│ expires_at              │
└─────────────────────────┘

┌─────────────────────────┐
│   repository_stats      │
├─────────────────────────┤
│ id (PK)                 │
│ repository_id (FK)      │
│ document_count          │
│ view_count              │
│ share_count             │
│ last_accessed_at        │
└─────────────────────────┘
```

---

## 3. 테이블 명세

### 3.1 users (사용자)
사용자 계정 정보를 저장하는 테이블

| 컬럼명 | 타입 | 제약조건 | 설명 |
|--------|------|----------|------|
| id | UUID | PRIMARY KEY | 사용자 고유 ID |
| email | VARCHAR(255) | UNIQUE, NOT NULL | 이메일 주소 |
| username | VARCHAR(50) | UNIQUE, NOT NULL | 사용자명 (URL 경로) |
| name | VARCHAR(100) | NOT NULL | 표시 이름 |
| avatar_url | VARCHAR(500) | NULLABLE | 프로필 이미지 URL |
| bio | TEXT | NULLABLE | 자기소개 |
| email_verified | BOOLEAN | DEFAULT TRUE | 이메일 인증 여부 (소셜 로그인으로 자동 인증) |
| created_at | TIMESTAMP | NOT NULL | 생성 일시 |
| updated_at | TIMESTAMP | NOT NULL | 수정 일시 |
| deleted_at | TIMESTAMP | NULLABLE | 삭제 일시 (Soft Delete) |

**주의사항**:
- 이 서비스는 소셜 로그인(OAuth)만 지원하므로 password_hash 컬럼은 제거됨
- 모든 사용자는 Google 또는 GitHub 계정으로만 가입 가능

**인덱스**:
- `idx_users_email` ON email
- `idx_users_username` ON username
- `idx_users_deleted_at` ON deleted_at (Soft Delete 쿼리 최적화)

**예제 데이터**:
```sql
INSERT INTO users (id, email, username, name, email_verified) VALUES
('550e8400-e29b-41d4-a716-446655440000', 'john@example.com', 'john', 'John Doe', true);
```

---

### 3.2 oauth_accounts (소셜 계정 연동)
소셜 로그인 계정 정보 (필수)

| 컬럼명 | 타입 | 제약조건 | 설명 |
|--------|------|----------|------|
| id | UUID | PRIMARY KEY | 고유 ID |
| user_id | UUID | FOREIGN KEY (users), NOT NULL | 사용자 ID |
| provider | VARCHAR(50) | NOT NULL | 제공자 (google, github) |
| provider_account_id | VARCHAR(255) | NOT NULL | 제공자의 사용자 ID |
| access_token | TEXT | NULLABLE | 액세스 토큰 (암호화 권장) |
| refresh_token | TEXT | NULLABLE | 리프레시 토큰 (암호화 권장) |
| expires_at | TIMESTAMP | NULLABLE | 토큰 만료 시간 |
| created_at | TIMESTAMP | NOT NULL | 생성 일시 |
| updated_at | TIMESTAMP | NOT NULL | 수정 일시 |

**제약조건**:
- UNIQUE(provider, provider_account_id) - 같은 소셜 계정 중복 연동 방지
- 모든 사용자는 최소 1개 이상의 oauth_account 보유 필수

**인덱스**:
- `idx_oauth_user_id` ON user_id
- `idx_oauth_provider` ON provider, provider_account_id

**CASCADE 정책**:
- User 삭제 시: oauth_accounts도 삭제 (CASCADE)

---

### 3.3 repositories (저장소)
링크를 저장하는 저장소

| 컬럼명 | 타입 | 제약조건 | 설명 |
|--------|------|----------|------|
| id | UUID | PRIMARY KEY | Repository 고유 ID |
| user_id | UUID | FOREIGN KEY (users) | 소유자 ID |
| parent_id | UUID | FOREIGN KEY (repositories), NULLABLE | 부모 Repository (Sub-repository인 경우) |
| name | VARCHAR(100) | NOT NULL | Repository 이름 |
| description | TEXT | NULLABLE | 설명 |
| icon | VARCHAR(10) | DEFAULT '📁' | 아이콘/이모지 |
| is_public | BOOLEAN | DEFAULT FALSE | 공개 여부 |
| slug | VARCHAR(100) | NOT NULL | URL-safe slug |
| position | INTEGER | DEFAULT 0 | 정렬 순서 |
| created_at | TIMESTAMP | NOT NULL | 생성 일시 |
| updated_at | TIMESTAMP | NOT NULL | 수정 일시 |
| deleted_at | TIMESTAMP | NULLABLE | 삭제 일시 |

**제약조건**:
- UNIQUE(user_id, slug) - 같은 사용자의 Repository slug는 중복 불가
- CHECK: Public repository 하위에는 Private sub-repository 생성 불가
  ```sql
  -- 부모가 Public이면 자식도 Public이어야 함
  CONSTRAINT check_public_inheritance
  CHECK (
    parent_id IS NULL OR
    is_public = TRUE OR
    (SELECT is_public FROM repositories WHERE id = parent_id) = FALSE
  )
  ```

**인덱스**:
- `idx_repos_user_id` ON user_id
- `idx_repos_parent_id` ON parent_id
- `idx_repos_slug` ON user_id, slug
- `idx_repos_is_public` ON is_public (Public repository 탐색)
- `idx_repos_deleted_at` ON deleted_at

**예제 데이터**:
```sql
INSERT INTO repositories (id, user_id, name, description, is_public, slug) VALUES
('650e8400-e29b-41d4-a716-446655440001',
 '550e8400-e29b-41d4-a716-446655440000',
 '개발 자료',
 '프론트엔드 개발 관련 자료 모음',
 false,
 'dev-resources');
```

---

### 3.4 documents (문서)
링크와 노트를 저장하는 문서

| 컬럼명 | 타입 | 제약조건 | 설명 |
|--------|------|----------|------|
| id | UUID | PRIMARY KEY | Document 고유 ID |
| repository_id | UUID | FOREIGN KEY (repositories) | 소속 Repository |
| user_id | UUID | FOREIGN KEY (users) | 작성자 ID |
| title | VARCHAR(500) | NOT NULL | 문서 제목 |
| url | TEXT | NOT NULL | 외부 링크 URL |
| content | TEXT | NULLABLE | 마크다운 노트 |
| link_metadata | JSONB | NULLABLE | 링크 메타데이터 |
| position | INTEGER | DEFAULT 0 | 정렬 순서 |
| created_at | TIMESTAMP | NOT NULL | 생성 일시 |
| updated_at | TIMESTAMP | NOT NULL | 수정 일시 |
| deleted_at | TIMESTAMP | NULLABLE | 삭제 일시 |

**link_metadata JSONB 구조**:
```json
{
  "og_title": "React - A JavaScript library",
  "og_description": "A JavaScript library for building user interfaces",
  "og_image": "https://react.dev/og-image.png",
  "og_url": "https://react.dev",
  "favicon": "https://react.dev/favicon.ico",
  "site_name": "React",
  "type": "website",
  "fetched_at": "2025-10-10T12:00:00Z"
}
```

**인덱스**:
- `idx_docs_repository_id` ON repository_id
- `idx_docs_user_id` ON user_id
- `idx_docs_created_at` ON created_at DESC
- `idx_docs_deleted_at` ON deleted_at
- `idx_docs_url_hash` ON MD5(url) - 중복 URL 체크용
- GIN 인덱스 ON link_metadata (JSONB 검색)

**Full-text Search**:
```sql
-- 전문 검색을 위한 tsvector 컬럼 추가
ALTER TABLE documents ADD COLUMN search_vector tsvector
  GENERATED ALWAYS AS (
    to_tsvector('english', coalesce(title, '')) ||
    to_tsvector('english', coalesce(content, ''))
  ) STORED;

CREATE INDEX idx_docs_search ON documents USING GIN (search_vector);
```

---

### 3.5 tags (태그)
사용자가 생성한 태그

| 컬럼명 | 타입 | 제약조건 | 설명 |
|--------|------|----------|------|
| id | UUID | PRIMARY KEY | 태그 고유 ID |
| user_id | UUID | FOREIGN KEY (users) | 생성자 ID |
| name | VARCHAR(50) | NOT NULL | 태그 이름 |
| color | VARCHAR(7) | DEFAULT '#3B82F6' | 태그 색상 (HEX) |
| created_at | TIMESTAMP | NOT NULL | 생성 일시 |
| updated_at | TIMESTAMP | NOT NULL | 수정 일시 |

**제약조건**:
- UNIQUE(user_id, name) - 같은 사용자의 태그명은 중복 불가

**인덱스**:
- `idx_tags_user_id` ON user_id
- `idx_tags_name` ON user_id, name

---

### 3.6 document_tags (문서-태그 관계)
Document와 Tag의 다대다 관계

| 컬럼명 | 타입 | 제약조건 | 설명 |
|--------|------|----------|------|
| id | UUID | PRIMARY KEY | 고유 ID |
| document_id | UUID | FOREIGN KEY (documents) | 문서 ID |
| tag_id | UUID | FOREIGN KEY (tags) | 태그 ID |
| created_at | TIMESTAMP | NOT NULL | 생성 일시 |

**제약조건**:
- UNIQUE(document_id, tag_id)

**인덱스**:
- `idx_doc_tags_document_id` ON document_id
- `idx_doc_tags_tag_id` ON tag_id

**CASCADE 정책**:
- Document 삭제 시: document_tags도 삭제 (CASCADE)
- Tag 삭제 시: document_tags도 삭제 (CASCADE)

---

### 3.7 repository_shares (Repository 공유)
Public Repository의 공유 정보

| 컬럼명 | 타입 | 제약조건 | 설명 |
|--------|------|----------|------|
| id | UUID | PRIMARY KEY | 고유 ID |
| repository_id | UUID | FOREIGN KEY (repositories) | Repository ID |
| share_token | VARCHAR(100) | UNIQUE, NOT NULL | 공유 토큰 |
| view_count | INTEGER | DEFAULT 0 | 조회수 |
| expires_at | TIMESTAMP | NULLABLE | 만료 시간 (선택적) |
| created_at | TIMESTAMP | NOT NULL | 생성 일시 |
| updated_at | TIMESTAMP | NOT NULL | 수정 일시 |

**인덱스**:
- `idx_shares_repository_id` ON repository_id
- `idx_shares_token` ON share_token

---

### 3.8 repository_stats (Repository 통계)
Repository의 통계 정보 (캐시 테이블)

| 컬럼명 | 타입 | 제약조건 | 설명 |
|--------|------|----------|------|
| id | UUID | PRIMARY KEY | 고유 ID |
| repository_id | UUID | FOREIGN KEY (repositories), UNIQUE | Repository ID |
| document_count | INTEGER | DEFAULT 0 | 문서 개수 |
| view_count | INTEGER | DEFAULT 0 | 조회수 |
| share_count | INTEGER | DEFAULT 0 | 공유 횟수 |
| last_accessed_at | TIMESTAMP | NULLABLE | 최근 접근 일시 |
| created_at | TIMESTAMP | NOT NULL | 생성 일시 |
| updated_at | TIMESTAMP | NOT NULL | 수정 일시 |

**인덱스**:
- `idx_stats_repository_id` ON repository_id

**트리거**:
- Document 생성/삭제 시 document_count 자동 업데이트

---

### 3.9 repository_members (Repository 멤버)
Repository 협업 멤버 관리 테이블

| 컬럼명 | 타입 | 제약조건 | 설명 |
|--------|------|----------|------|
| id | UUID | PRIMARY KEY | 고유 ID |
| repository_id | UUID | FOREIGN KEY (repositories), NOT NULL | Repository ID |
| user_id | UUID | FOREIGN KEY (users), NOT NULL | 멤버 사용자 ID |
| role | VARCHAR(20) | NOT NULL | 역할 (owner, editor) |
| invited_by | UUID | FOREIGN KEY (users), NULLABLE | 초대한 사용자 ID |
| invited_at | TIMESTAMP | NOT NULL | 초대 일시 |
| accepted_at | TIMESTAMP | NULLABLE | 초대 수락 일시 (NULL = 대기 중) |
| created_at | TIMESTAMP | NOT NULL | 생성 일시 |
| updated_at | TIMESTAMP | NOT NULL | 수정 일시 |

**제약조건**:
- UNIQUE(repository_id, user_id) - 같은 사용자는 한 Repository에 한 번만 등록
- CHECK(role IN ('owner', 'editor'))
- Owner는 invited_by가 NULL이고 accepted_at이 생성 시점과 동일

**인덱스**:
- `idx_members_repository_id` ON repository_id
- `idx_members_user_id` ON user_id
- `idx_members_role` ON role
- `idx_members_accepted` ON accepted_at (초대 대기 중인 멤버 조회)

**CASCADE 정책**:
- Repository 삭제 시: repository_members도 삭제 (CASCADE)
- User 삭제 시: repository_members도 삭제 (CASCADE)

**비즈니스 로직**:
- Repository 생성 시 자동으로 Owner 멤버 생성
- Owner는 Repository당 1명만 존재 (user_id = repositories.user_id)
- Editor는 무제한
- Private Repository만 멤버 초대 가능
- 초대 수락 전까지 Repository 접근 불가
- Sub-repository는 부모 Repository의 멤버 권한 상속

**예제 데이터**:
```sql
-- Owner (Repository 생성자)
INSERT INTO repository_members (id, repository_id, user_id, role, invited_at, accepted_at) VALUES
('a50e8400-e29b-41d4-a716-446655440010',
 '650e8400-e29b-41d4-a716-446655440001',
 '550e8400-e29b-41d4-a716-446655440000',
 'owner',
 CURRENT_TIMESTAMP,
 CURRENT_TIMESTAMP);

-- Editor (초대받은 멤버, 수락 완료)
INSERT INTO repository_members (id, repository_id, user_id, role, invited_by, invited_at, accepted_at) VALUES
('b50e8400-e29b-41d4-a716-446655440011',
 '650e8400-e29b-41d4-a716-446655440001',
 '650e8400-e29b-41d4-a716-446655440002',
 'editor',
 '550e8400-e29b-41d4-a716-446655440000',
 CURRENT_TIMESTAMP,
 CURRENT_TIMESTAMP);

-- Editor (초대받은 멤버, 대기 중)
INSERT INTO repository_members (id, repository_id, user_id, role, invited_by, invited_at, accepted_at) VALUES
('c50e8400-e29b-41d4-a716-446655440012',
 '650e8400-e29b-41d4-a716-446655440001',
 '750e8400-e29b-41d4-a716-446655440003',
 'editor',
 '550e8400-e29b-41d4-a716-446655440000',
 CURRENT_TIMESTAMP,
 NULL);
```

---

## 4. 인덱스 전략

### 4.1 조회 성능 최적화
```sql
-- 사용자의 Repository 목록 조회
CREATE INDEX idx_repos_user_position
ON repositories(user_id, position)
WHERE deleted_at IS NULL;

-- Repository의 Document 목록 조회
CREATE INDEX idx_docs_repo_position
ON documents(repository_id, position)
WHERE deleted_at IS NULL;

-- Public Repository 탐색
CREATE INDEX idx_repos_public_created
ON repositories(is_public, created_at DESC)
WHERE deleted_at IS NULL AND is_public = TRUE;
```

### 4.2 복합 인덱스
```sql
-- 검색 + 필터링
CREATE INDEX idx_docs_search_filter
ON documents(repository_id, created_at DESC, deleted_at);

-- 태그 필터링
CREATE INDEX idx_doc_tags_filter
ON document_tags(tag_id, document_id);

-- Repository 멤버 조회 (사용자가 속한 Repository 찾기)
CREATE INDEX idx_members_user_accepted
ON repository_members(user_id, accepted_at)
WHERE accepted_at IS NOT NULL;

-- Repository 초대 대기 중인 멤버 조회
CREATE INDEX idx_members_pending
ON repository_members(user_id)
WHERE accepted_at IS NULL;
```

---

## 5. 데이터 제약사항

### 5.1 비즈니스 규칙 제약
```sql
-- 1. Repository 이름 길이 제한
ALTER TABLE repositories
ADD CONSTRAINT check_name_length
CHECK (char_length(name) >= 1 AND char_length(name) <= 100);

-- 2. URL 형식 검증 (기본적인 체크)
ALTER TABLE documents
ADD CONSTRAINT check_url_format
CHECK (url ~* '^https?://');

-- 3. 이메일 형식 검증
ALTER TABLE users
ADD CONSTRAINT check_email_format
CHECK (email ~* '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$');

-- 4. 태그 이름 제약
ALTER TABLE tags
ADD CONSTRAINT check_tag_name
CHECK (char_length(name) >= 1 AND char_length(name) <= 50);
```

### 5.2 Soft Delete 구현
```sql
-- Soft Delete를 위한 뷰 생성 (deleted_at이 NULL인 것만)
CREATE VIEW active_repositories AS
SELECT * FROM repositories WHERE deleted_at IS NULL;

CREATE VIEW active_documents AS
SELECT * FROM documents WHERE deleted_at IS NULL;
```

### 5.3 계층 구조 제약
```sql
-- Sub-repository의 최대 깊이 제한 (5단계)
-- 재귀 CTE로 깊이 체크하는 함수
CREATE OR REPLACE FUNCTION check_repository_depth()
RETURNS TRIGGER AS $$
DECLARE
  depth INTEGER;
BEGIN
  WITH RECURSIVE repo_tree AS (
    SELECT id, parent_id, 1 as level
    FROM repositories
    WHERE id = NEW.id

    UNION ALL

    SELECT r.id, r.parent_id, rt.level + 1
    FROM repositories r
    INNER JOIN repo_tree rt ON r.id = rt.parent_id
  )
  SELECT MAX(level) INTO depth FROM repo_tree;

  IF depth > 5 THEN
    RAISE EXCEPTION 'Repository depth cannot exceed 5 levels';
  END IF;

  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER check_depth_before_insert
BEFORE INSERT OR UPDATE ON repositories
FOR EACH ROW EXECUTE FUNCTION check_repository_depth();
```

---

## 6. 데이터 마이그레이션 전략

### 6.1 초기 마이그레이션 순서
1. users 테이블 생성
2. oauth_accounts 테이블 생성
3. repositories 테이블 생성
4. repository_members 테이블 생성
5. documents 테이블 생성
6. tags 테이블 생성
7. document_tags 테이블 생성
8. repository_shares 테이블 생성
9. repository_stats 테이블 생성
10. 인덱스 생성
11. 트리거 및 제약조건 생성

### 6.2 시드 데이터
```sql
-- 개발 환경용 샘플 사용자
INSERT INTO users (id, email, username, name, email_verified) VALUES
('550e8400-e29b-41d4-a716-446655440000', 'demo@linktoss.com', 'demo', 'Demo User', true);

-- 샘플 Repository
INSERT INTO repositories (id, user_id, name, description, is_public, slug) VALUES
('650e8400-e29b-41d4-a716-446655440001',
 '550e8400-e29b-41d4-a716-446655440000',
 'My First Repository',
 'Welcome to LinkToss!',
 false,
 'my-first-repository');
```

---

## 7. 백업 및 복구 전략

### 7.1 백업 정책
- **Full Backup**: 매일 1회 (새벽 2시)
- **Incremental Backup**: 6시간마다
- **보관 기간**: 30일

### 7.2 중요 데이터 우선순위
1. users (최우선)
2. repositories
3. documents
4. tags, document_tags
5. repository_stats (재생성 가능)

---

## 8. 성능 고려사항

### 8.1 파티셔닝
- documents 테이블: created_at 기준 월별 파티셔닝 (선택적)
- 데이터 증가 시 적용 검토

### 8.2 캐싱 전략
- **Redis 캐시**:
  - Repository 목록: TTL 5분
  - Document 상세: TTL 10분
  - Public Repository 목록: TTL 30분
  - 사용자 통계: TTL 1시간

### 8.3 읽기 성능 최적화
```sql
-- Repository with document count (Materialized View)
CREATE MATERIALIZED VIEW repository_with_counts AS
SELECT
  r.*,
  COUNT(d.id) as document_count
FROM repositories r
LEFT JOIN documents d ON d.repository_id = r.id AND d.deleted_at IS NULL
WHERE r.deleted_at IS NULL
GROUP BY r.id;

-- 인덱스
CREATE INDEX idx_repo_counts_user ON repository_with_counts(user_id);

-- 주기적으로 리프레시 (cron job)
REFRESH MATERIALIZED VIEW CONCURRENTLY repository_with_counts;
```

---

## 9. 보안 고려사항

### 9.1 민감 데이터 암호화
```sql
-- PostgreSQL pgcrypto 확장 사용
CREATE EXTENSION IF NOT EXISTS pgcrypto;

-- OAuth 토큰 암호화 저장
-- 애플리케이션 레벨에서 암호화 후 저장
```

### 9.2 Row Level Security (RLS)
```sql
-- Repository 접근 권한: Owner, 멤버, 또는 Public
ALTER TABLE repositories ENABLE ROW LEVEL SECURITY;

CREATE POLICY repository_access_policy ON repositories
  FOR ALL
  TO authenticated_users
  USING (
    user_id = current_user_id() OR
    is_public = TRUE OR
    EXISTS (
      SELECT 1 FROM repository_members
      WHERE repository_id = repositories.id
        AND user_id = current_user_id()
        AND accepted_at IS NOT NULL
    )
  );

-- Document 접근 권한: Repository 멤버만
ALTER TABLE documents ENABLE ROW LEVEL SECURITY;

CREATE POLICY document_access_policy ON documents
  FOR ALL
  TO authenticated_users
  USING (
    EXISTS (
      SELECT 1 FROM repositories r
      LEFT JOIN repository_members rm ON rm.repository_id = r.id
      WHERE r.id = documents.repository_id
        AND (
          r.user_id = current_user_id() OR
          r.is_public = TRUE OR
          (rm.user_id = current_user_id() AND rm.accepted_at IS NOT NULL)
        )
    )
  );
```

---

## 10. 변경 이력

| 날짜 | 버전 | 변경 내용 | 작성자 |
|------|------|-----------|--------|
| 2025-10-10 | 1.0 | 초기 작성 | Engineering Team |
| 2025-10-10 | 1.1 | repository_members 테이블 추가 (협업 기능), password_hash 제거 (소셜 로그인 전용), RLS 정책 업데이트 | Engineering Team |

---

## 부록 A: SQL 스키마 전체 코드

```sql
-- UUID 확장 활성화
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- users 테이블 (소셜 로그인 전용, password_hash 제거)
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  email VARCHAR(255) UNIQUE NOT NULL,
  username VARCHAR(50) UNIQUE NOT NULL,
  name VARCHAR(100) NOT NULL,
  avatar_url VARCHAR(500),
  bio TEXT,
  email_verified BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  deleted_at TIMESTAMP WITH TIME ZONE
);

-- oauth_accounts 테이블
CREATE TABLE oauth_accounts (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  provider VARCHAR(50) NOT NULL,
  provider_account_id VARCHAR(255) NOT NULL,
  access_token TEXT,
  refresh_token TEXT,
  expires_at TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(provider, provider_account_id)
);

-- repositories 테이블
CREATE TABLE repositories (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  parent_id UUID REFERENCES repositories(id) ON DELETE CASCADE,
  name VARCHAR(100) NOT NULL,
  description TEXT,
  icon VARCHAR(10) DEFAULT '📁',
  is_public BOOLEAN DEFAULT FALSE,
  slug VARCHAR(100) NOT NULL,
  position INTEGER DEFAULT 0,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  deleted_at TIMESTAMP WITH TIME ZONE,
  UNIQUE(user_id, slug)
);

-- documents 테이블
CREATE TABLE documents (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  repository_id UUID NOT NULL REFERENCES repositories(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  title VARCHAR(500) NOT NULL,
  url TEXT NOT NULL,
  content TEXT,
  link_metadata JSONB,
  position INTEGER DEFAULT 0,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  deleted_at TIMESTAMP WITH TIME ZONE
);

-- tags 테이블
CREATE TABLE tags (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  name VARCHAR(50) NOT NULL,
  color VARCHAR(7) DEFAULT '#3B82F6',
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(user_id, name)
);

-- document_tags 테이블
CREATE TABLE document_tags (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  document_id UUID NOT NULL REFERENCES documents(id) ON DELETE CASCADE,
  tag_id UUID NOT NULL REFERENCES tags(id) ON DELETE CASCADE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(document_id, tag_id)
);

-- repository_shares 테이블
CREATE TABLE repository_shares (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  repository_id UUID NOT NULL REFERENCES repositories(id) ON DELETE CASCADE,
  share_token VARCHAR(100) UNIQUE NOT NULL,
  view_count INTEGER DEFAULT 0,
  expires_at TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- repository_stats 테이블
CREATE TABLE repository_stats (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  repository_id UUID UNIQUE NOT NULL REFERENCES repositories(id) ON DELETE CASCADE,
  document_count INTEGER DEFAULT 0,
  view_count INTEGER DEFAULT 0,
  share_count INTEGER DEFAULT 0,
  last_accessed_at TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- repository_members 테이블 (협업 기능)
CREATE TABLE repository_members (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  repository_id UUID NOT NULL REFERENCES repositories(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  role VARCHAR(20) NOT NULL CHECK (role IN ('owner', 'editor')),
  invited_by UUID REFERENCES users(id) ON DELETE SET NULL,
  invited_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
  accepted_at TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(repository_id, user_id)
);

-- 인덱스 생성
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_repos_user_id ON repositories(user_id);
CREATE INDEX idx_repos_parent_id ON repositories(parent_id);
CREATE INDEX idx_docs_repository_id ON documents(repository_id);
CREATE INDEX idx_docs_user_id ON documents(user_id);
CREATE INDEX idx_tags_user_id ON tags(user_id);
CREATE INDEX idx_doc_tags_document_id ON document_tags(document_id);
CREATE INDEX idx_doc_tags_tag_id ON document_tags(tag_id);
CREATE INDEX idx_members_repository_id ON repository_members(repository_id);
CREATE INDEX idx_members_user_id ON repository_members(user_id);
CREATE INDEX idx_members_role ON repository_members(role);

-- updated_at 자동 업데이트 트리거 함수
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = CURRENT_TIMESTAMP;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- 각 테이블에 트리거 적용
CREATE TRIGGER update_users_updated_at BEFORE UPDATE ON users
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
CREATE TRIGGER update_repositories_updated_at BEFORE UPDATE ON repositories
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
CREATE TRIGGER update_documents_updated_at BEFORE UPDATE ON documents
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
CREATE TRIGGER update_repository_members_updated_at BEFORE UPDATE ON repository_members
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- Repository 생성 시 Owner 멤버 자동 생성 트리거
CREATE OR REPLACE FUNCTION create_repository_owner()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO repository_members (repository_id, user_id, role, invited_at, accepted_at)
  VALUES (NEW.id, NEW.user_id, 'owner', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP);
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER create_owner_after_repository_insert
AFTER INSERT ON repositories
FOR EACH ROW EXECUTE FUNCTION create_repository_owner();
```
