# LinkToss - ë°ì´í„° ëª¨ë¸ ì„¤ê³„ì„œ

## ğŸ“Œ ë¬¸ì„œ ì •ë³´
- **ë²„ì „**: 1.0
- **ìµœì¢… ìˆ˜ì •ì¼**: 2025-10-10
- **ì‘ì„±ì**: Engineering Team
- **ìƒíƒœ**: Draft

## ëª©ì°¨
1. [ê°œìš”](#1-ê°œìš”)
2. [ERD (Entity Relationship Diagram)](#2-erd-entity-relationship-diagram)
3. [í…Œì´ë¸” ëª…ì„¸](#3-í…Œì´ë¸”-ëª…ì„¸)
4. [ì¸ë±ìŠ¤ ì „ëµ](#4-ì¸ë±ìŠ¤-ì „ëµ)
5. [ë°ì´í„° ì œì•½ì‚¬í•­](#5-ë°ì´í„°-ì œì•½ì‚¬í•­)

---

## 1. ê°œìš”

### 1.1 ë°ì´í„°ë² ì´ìŠ¤ ì„ íƒ
- **Primary DB**: PostgreSQL 15+
  - ì´ìœ : ACID íŠ¸ëœì­ì…˜, JSON ì§€ì›, í™•ì¥ì„±, ì˜¤í”ˆì†ŒìŠ¤
- **Cache**: Redis
  - ì´ìœ : ì„¸ì…˜ ê´€ë¦¬, ìì£¼ ì¡°íšŒë˜ëŠ” ë°ì´í„° ìºì‹±

### 1.2 ë„¤ì´ë° ì»¨ë²¤ì…˜
- í…Œì´ë¸”ëª…: snake_case, ë³µìˆ˜í˜• (users, repositories)
- ì»¬ëŸ¼ëª…: snake_case
- Primary Key: id (UUID)
- Foreign Key: {í…Œì´ë¸”ëª…}_id (user_id, repository_id)
- íƒ€ì„ìŠ¤íƒ¬í”„: created_at, updated_at

### 1.3 ê³µí†µ ì»¬ëŸ¼
ëª¨ë“  í…Œì´ë¸”ì— í¬í•¨:
- `id`: UUID PRIMARY KEY
- `created_at`: TIMESTAMP WITH TIME ZONE
- `updated_at`: TIMESTAMP WITH TIME ZONE
- `deleted_at`: TIMESTAMP WITH TIME ZONE (Soft Delete)

---

## 2. ERD (Entity Relationship Diagram)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     users       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)         â”‚
â”‚ email           â”‚
â”‚ username        â”‚
â”‚ name            â”‚
â”‚ avatar_url      â”‚
â”‚ bio             â”‚
â”‚ email_verified  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ 1:N (owner)
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    repositories         â”‚â—„â”€â”€â”€â”€â”€â”€N:Mâ”€â”€â”€â”€â”‚ repository_members   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)                 â”‚              â”‚ id (PK)              â”‚
â”‚ user_id (FK) [owner]    â”‚              â”‚ repository_id (FK)   â”‚
â”‚ parent_id (FK, nullable)â”‚â—„â”€â”€â”€â”€â”€â”       â”‚ user_id (FK)         â”‚
â”‚ name                    â”‚      â”‚       â”‚ role (owner/editor)  â”‚
â”‚ description             â”‚      â”‚       â”‚ invited_at           â”‚
â”‚ icon                    â”‚      â”‚       â”‚ accepted_at          â”‚
â”‚ is_public               â”‚      â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ slug                    â”‚      â”‚ Self-referencing
â”‚ position                â”‚â”€â”€â”€â”€â”€â”€â”˜ (Sub-repository)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ 1:N
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     documents           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)                 â”‚
â”‚ repository_id (FK)      â”‚
â”‚ user_id (FK)            â”‚
â”‚ title                   â”‚
â”‚ url                     â”‚
â”‚ content (markdown)      â”‚
â”‚ link_metadata (JSON)    â”‚
â”‚ position                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ N:M
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   document_tags         â”‚    N:M  â”‚      tags       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â—„â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)                 â”‚         â”‚ id (PK)         â”‚
â”‚ document_id (FK)        â”‚         â”‚ name            â”‚
â”‚ tag_id (FK)             â”‚         â”‚ color           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚ user_id (FK)    â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     oauth_accounts      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)                 â”‚
â”‚ user_id (FK)            â”‚
â”‚ provider                â”‚
â”‚ provider_account_id     â”‚
â”‚ access_token            â”‚
â”‚ refresh_token           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   repository_shares     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)                 â”‚
â”‚ repository_id (FK)      â”‚
â”‚ share_token             â”‚
â”‚ view_count              â”‚
â”‚ expires_at              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   repository_stats      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)                 â”‚
â”‚ repository_id (FK)      â”‚
â”‚ document_count          â”‚
â”‚ view_count              â”‚
â”‚ share_count             â”‚
â”‚ last_accessed_at        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. í…Œì´ë¸” ëª…ì„¸

### 3.1 users (ì‚¬ìš©ì)
ì‚¬ìš©ì ê³„ì • ì •ë³´ë¥¼ ì €ì¥í•˜ëŠ” í…Œì´ë¸”

| ì»¬ëŸ¼ëª… | íƒ€ì… | ì œì•½ì¡°ê±´ | ì„¤ëª… |
|--------|------|----------|------|
| id | UUID | PRIMARY KEY | ì‚¬ìš©ì ê³ ìœ  ID |
| email | VARCHAR(255) | UNIQUE, NOT NULL | ì´ë©”ì¼ ì£¼ì†Œ |
| username | VARCHAR(50) | UNIQUE, NOT NULL | ì‚¬ìš©ìëª… (URL ê²½ë¡œ) |
| name | VARCHAR(100) | NOT NULL | í‘œì‹œ ì´ë¦„ |
| avatar_url | VARCHAR(500) | NULLABLE | í”„ë¡œí•„ ì´ë¯¸ì§€ URL |
| bio | TEXT | NULLABLE | ìê¸°ì†Œê°œ |
| email_verified | BOOLEAN | DEFAULT TRUE | ì´ë©”ì¼ ì¸ì¦ ì—¬ë¶€ (ì†Œì…œ ë¡œê·¸ì¸ìœ¼ë¡œ ìë™ ì¸ì¦) |
| created_at | TIMESTAMP | NOT NULL | ìƒì„± ì¼ì‹œ |
| updated_at | TIMESTAMP | NOT NULL | ìˆ˜ì • ì¼ì‹œ |
| deleted_at | TIMESTAMP | NULLABLE | ì‚­ì œ ì¼ì‹œ (Soft Delete) |

**ì£¼ì˜ì‚¬í•­**:
- ì´ ì„œë¹„ìŠ¤ëŠ” ì†Œì…œ ë¡œê·¸ì¸(OAuth)ë§Œ ì§€ì›í•˜ë¯€ë¡œ password_hash ì»¬ëŸ¼ì€ ì œê±°ë¨
- ëª¨ë“  ì‚¬ìš©ìëŠ” Google ë˜ëŠ” GitHub ê³„ì •ìœ¼ë¡œë§Œ ê°€ì… ê°€ëŠ¥

**ì¸ë±ìŠ¤**:
- `idx_users_email` ON email
- `idx_users_username` ON username
- `idx_users_deleted_at` ON deleted_at (Soft Delete ì¿¼ë¦¬ ìµœì í™”)

**ì˜ˆì œ ë°ì´í„°**:
```sql
INSERT INTO users (id, email, username, name, email_verified) VALUES
('550e8400-e29b-41d4-a716-446655440000', 'john@example.com', 'john', 'John Doe', true);
```

---

### 3.2 oauth_accounts (ì†Œì…œ ê³„ì • ì—°ë™)
ì†Œì…œ ë¡œê·¸ì¸ ê³„ì • ì •ë³´ (í•„ìˆ˜)

| ì»¬ëŸ¼ëª… | íƒ€ì… | ì œì•½ì¡°ê±´ | ì„¤ëª… |
|--------|------|----------|------|
| id | UUID | PRIMARY KEY | ê³ ìœ  ID |
| user_id | UUID | FOREIGN KEY (users), NOT NULL | ì‚¬ìš©ì ID |
| provider | VARCHAR(50) | NOT NULL | ì œê³µì (google, github) |
| provider_account_id | VARCHAR(255) | NOT NULL | ì œê³µìì˜ ì‚¬ìš©ì ID |
| access_token | TEXT | NULLABLE | ì•¡ì„¸ìŠ¤ í† í° (ì•”í˜¸í™” ê¶Œì¥) |
| refresh_token | TEXT | NULLABLE | ë¦¬í”„ë ˆì‹œ í† í° (ì•”í˜¸í™” ê¶Œì¥) |
| expires_at | TIMESTAMP | NULLABLE | í† í° ë§Œë£Œ ì‹œê°„ |
| created_at | TIMESTAMP | NOT NULL | ìƒì„± ì¼ì‹œ |
| updated_at | TIMESTAMP | NOT NULL | ìˆ˜ì • ì¼ì‹œ |

**ì œì•½ì¡°ê±´**:
- UNIQUE(provider, provider_account_id) - ê°™ì€ ì†Œì…œ ê³„ì • ì¤‘ë³µ ì—°ë™ ë°©ì§€
- ëª¨ë“  ì‚¬ìš©ìëŠ” ìµœì†Œ 1ê°œ ì´ìƒì˜ oauth_account ë³´ìœ  í•„ìˆ˜

**ì¸ë±ìŠ¤**:
- `idx_oauth_user_id` ON user_id
- `idx_oauth_provider` ON provider, provider_account_id

**CASCADE ì •ì±…**:
- User ì‚­ì œ ì‹œ: oauth_accountsë„ ì‚­ì œ (CASCADE)

---

### 3.3 repositories (ì €ì¥ì†Œ)
ë§í¬ë¥¼ ì €ì¥í•˜ëŠ” ì €ì¥ì†Œ

| ì»¬ëŸ¼ëª… | íƒ€ì… | ì œì•½ì¡°ê±´ | ì„¤ëª… |
|--------|------|----------|------|
| id | UUID | PRIMARY KEY | Repository ê³ ìœ  ID |
| user_id | UUID | FOREIGN KEY (users) | ì†Œìœ ì ID |
| parent_id | UUID | FOREIGN KEY (repositories), NULLABLE | ë¶€ëª¨ Repository (Sub-repositoryì¸ ê²½ìš°) |
| name | VARCHAR(100) | NOT NULL | Repository ì´ë¦„ |
| description | TEXT | NULLABLE | ì„¤ëª… |
| icon | VARCHAR(10) | DEFAULT 'ğŸ“' | ì•„ì´ì½˜/ì´ëª¨ì§€ |
| is_public | BOOLEAN | DEFAULT FALSE | ê³µê°œ ì—¬ë¶€ |
| slug | VARCHAR(100) | NOT NULL | URL-safe slug |
| position | INTEGER | DEFAULT 0 | ì •ë ¬ ìˆœì„œ |
| created_at | TIMESTAMP | NOT NULL | ìƒì„± ì¼ì‹œ |
| updated_at | TIMESTAMP | NOT NULL | ìˆ˜ì • ì¼ì‹œ |
| deleted_at | TIMESTAMP | NULLABLE | ì‚­ì œ ì¼ì‹œ |

**ì œì•½ì¡°ê±´**:
- UNIQUE(user_id, slug) - ê°™ì€ ì‚¬ìš©ìì˜ Repository slugëŠ” ì¤‘ë³µ ë¶ˆê°€
- CHECK: Public repository í•˜ìœ„ì—ëŠ” Private sub-repository ìƒì„± ë¶ˆê°€
  ```sql
  -- ë¶€ëª¨ê°€ Publicì´ë©´ ìì‹ë„ Publicì´ì–´ì•¼ í•¨
  CONSTRAINT check_public_inheritance
  CHECK (
    parent_id IS NULL OR
    is_public = TRUE OR
    (SELECT is_public FROM repositories WHERE id = parent_id) = FALSE
  )
  ```

**ì¸ë±ìŠ¤**:
- `idx_repos_user_id` ON user_id
- `idx_repos_parent_id` ON parent_id
- `idx_repos_slug` ON user_id, slug
- `idx_repos_is_public` ON is_public (Public repository íƒìƒ‰)
- `idx_repos_deleted_at` ON deleted_at

**ì˜ˆì œ ë°ì´í„°**:
```sql
INSERT INTO repositories (id, user_id, name, description, is_public, slug) VALUES
('650e8400-e29b-41d4-a716-446655440001',
 '550e8400-e29b-41d4-a716-446655440000',
 'ê°œë°œ ìë£Œ',
 'í”„ë¡ íŠ¸ì—”ë“œ ê°œë°œ ê´€ë ¨ ìë£Œ ëª¨ìŒ',
 false,
 'dev-resources');
```

---

### 3.4 documents (ë¬¸ì„œ)
ë§í¬ì™€ ë…¸íŠ¸ë¥¼ ì €ì¥í•˜ëŠ” ë¬¸ì„œ

| ì»¬ëŸ¼ëª… | íƒ€ì… | ì œì•½ì¡°ê±´ | ì„¤ëª… |
|--------|------|----------|------|
| id | UUID | PRIMARY KEY | Document ê³ ìœ  ID |
| repository_id | UUID | FOREIGN KEY (repositories) | ì†Œì† Repository |
| user_id | UUID | FOREIGN KEY (users) | ì‘ì„±ì ID |
| title | VARCHAR(500) | NOT NULL | ë¬¸ì„œ ì œëª© |
| url | TEXT | NOT NULL | ì™¸ë¶€ ë§í¬ URL |
| content | TEXT | NULLABLE | ë§ˆí¬ë‹¤ìš´ ë…¸íŠ¸ |
| link_metadata | JSONB | NULLABLE | ë§í¬ ë©”íƒ€ë°ì´í„° |
| position | INTEGER | DEFAULT 0 | ì •ë ¬ ìˆœì„œ |
| created_at | TIMESTAMP | NOT NULL | ìƒì„± ì¼ì‹œ |
| updated_at | TIMESTAMP | NOT NULL | ìˆ˜ì • ì¼ì‹œ |
| deleted_at | TIMESTAMP | NULLABLE | ì‚­ì œ ì¼ì‹œ |

**link_metadata JSONB êµ¬ì¡°**:
```json
{
  "og_title": "React - A JavaScript library",
  "og_description": "A JavaScript library for building user interfaces",
  "og_image": "https://react.dev/og-image.png",
  "og_url": "https://react.dev",
  "favicon": "https://react.dev/favicon.ico",
  "site_name": "React",
  "type": "website",
  "fetched_at": "2025-10-10T12:00:00Z"
}
```

**ì¸ë±ìŠ¤**:
- `idx_docs_repository_id` ON repository_id
- `idx_docs_user_id` ON user_id
- `idx_docs_created_at` ON created_at DESC
- `idx_docs_deleted_at` ON deleted_at
- `idx_docs_url_hash` ON MD5(url) - ì¤‘ë³µ URL ì²´í¬ìš©
- GIN ì¸ë±ìŠ¤ ON link_metadata (JSONB ê²€ìƒ‰)

**Full-text Search**:
```sql
-- ì „ë¬¸ ê²€ìƒ‰ì„ ìœ„í•œ tsvector ì»¬ëŸ¼ ì¶”ê°€
ALTER TABLE documents ADD COLUMN search_vector tsvector
  GENERATED ALWAYS AS (
    to_tsvector('english', coalesce(title, '')) ||
    to_tsvector('english', coalesce(content, ''))
  ) STORED;

CREATE INDEX idx_docs_search ON documents USING GIN (search_vector);
```

---

### 3.5 tags (íƒœê·¸)
ì‚¬ìš©ìê°€ ìƒì„±í•œ íƒœê·¸

| ì»¬ëŸ¼ëª… | íƒ€ì… | ì œì•½ì¡°ê±´ | ì„¤ëª… |
|--------|------|----------|------|
| id | UUID | PRIMARY KEY | íƒœê·¸ ê³ ìœ  ID |
| user_id | UUID | FOREIGN KEY (users) | ìƒì„±ì ID |
| name | VARCHAR(50) | NOT NULL | íƒœê·¸ ì´ë¦„ |
| color | VARCHAR(7) | DEFAULT '#3B82F6' | íƒœê·¸ ìƒ‰ìƒ (HEX) |
| created_at | TIMESTAMP | NOT NULL | ìƒì„± ì¼ì‹œ |
| updated_at | TIMESTAMP | NOT NULL | ìˆ˜ì • ì¼ì‹œ |

**ì œì•½ì¡°ê±´**:
- UNIQUE(user_id, name) - ê°™ì€ ì‚¬ìš©ìì˜ íƒœê·¸ëª…ì€ ì¤‘ë³µ ë¶ˆê°€

**ì¸ë±ìŠ¤**:
- `idx_tags_user_id` ON user_id
- `idx_tags_name` ON user_id, name

---

### 3.6 document_tags (ë¬¸ì„œ-íƒœê·¸ ê´€ê³„)
Documentì™€ Tagì˜ ë‹¤ëŒ€ë‹¤ ê´€ê³„

| ì»¬ëŸ¼ëª… | íƒ€ì… | ì œì•½ì¡°ê±´ | ì„¤ëª… |
|--------|------|----------|------|
| id | UUID | PRIMARY KEY | ê³ ìœ  ID |
| document_id | UUID | FOREIGN KEY (documents) | ë¬¸ì„œ ID |
| tag_id | UUID | FOREIGN KEY (tags) | íƒœê·¸ ID |
| created_at | TIMESTAMP | NOT NULL | ìƒì„± ì¼ì‹œ |

**ì œì•½ì¡°ê±´**:
- UNIQUE(document_id, tag_id)

**ì¸ë±ìŠ¤**:
- `idx_doc_tags_document_id` ON document_id
- `idx_doc_tags_tag_id` ON tag_id

**CASCADE ì •ì±…**:
- Document ì‚­ì œ ì‹œ: document_tagsë„ ì‚­ì œ (CASCADE)
- Tag ì‚­ì œ ì‹œ: document_tagsë„ ì‚­ì œ (CASCADE)

---

### 3.7 repository_shares (Repository ê³µìœ )
Public Repositoryì˜ ê³µìœ  ì •ë³´

| ì»¬ëŸ¼ëª… | íƒ€ì… | ì œì•½ì¡°ê±´ | ì„¤ëª… |
|--------|------|----------|------|
| id | UUID | PRIMARY KEY | ê³ ìœ  ID |
| repository_id | UUID | FOREIGN KEY (repositories) | Repository ID |
| share_token | VARCHAR(100) | UNIQUE, NOT NULL | ê³µìœ  í† í° |
| view_count | INTEGER | DEFAULT 0 | ì¡°íšŒìˆ˜ |
| expires_at | TIMESTAMP | NULLABLE | ë§Œë£Œ ì‹œê°„ (ì„ íƒì ) |
| created_at | TIMESTAMP | NOT NULL | ìƒì„± ì¼ì‹œ |
| updated_at | TIMESTAMP | NOT NULL | ìˆ˜ì • ì¼ì‹œ |

**ì¸ë±ìŠ¤**:
- `idx_shares_repository_id` ON repository_id
- `idx_shares_token` ON share_token

---

### 3.8 repository_stats (Repository í†µê³„)
Repositoryì˜ í†µê³„ ì •ë³´ (ìºì‹œ í…Œì´ë¸”)

| ì»¬ëŸ¼ëª… | íƒ€ì… | ì œì•½ì¡°ê±´ | ì„¤ëª… |
|--------|------|----------|------|
| id | UUID | PRIMARY KEY | ê³ ìœ  ID |
| repository_id | UUID | FOREIGN KEY (repositories), UNIQUE | Repository ID |
| document_count | INTEGER | DEFAULT 0 | ë¬¸ì„œ ê°œìˆ˜ |
| view_count | INTEGER | DEFAULT 0 | ì¡°íšŒìˆ˜ |
| share_count | INTEGER | DEFAULT 0 | ê³µìœ  íšŸìˆ˜ |
| last_accessed_at | TIMESTAMP | NULLABLE | ìµœê·¼ ì ‘ê·¼ ì¼ì‹œ |
| created_at | TIMESTAMP | NOT NULL | ìƒì„± ì¼ì‹œ |
| updated_at | TIMESTAMP | NOT NULL | ìˆ˜ì • ì¼ì‹œ |

**ì¸ë±ìŠ¤**:
- `idx_stats_repository_id` ON repository_id

**íŠ¸ë¦¬ê±°**:
- Document ìƒì„±/ì‚­ì œ ì‹œ document_count ìë™ ì—…ë°ì´íŠ¸

---

### 3.9 repository_members (Repository ë©¤ë²„)
Repository í˜‘ì—… ë©¤ë²„ ê´€ë¦¬ í…Œì´ë¸”

| ì»¬ëŸ¼ëª… | íƒ€ì… | ì œì•½ì¡°ê±´ | ì„¤ëª… |
|--------|------|----------|------|
| id | UUID | PRIMARY KEY | ê³ ìœ  ID |
| repository_id | UUID | FOREIGN KEY (repositories), NOT NULL | Repository ID |
| user_id | UUID | FOREIGN KEY (users), NOT NULL | ë©¤ë²„ ì‚¬ìš©ì ID |
| role | VARCHAR(20) | NOT NULL | ì—­í•  (owner, editor) |
| invited_by | UUID | FOREIGN KEY (users), NULLABLE | ì´ˆëŒ€í•œ ì‚¬ìš©ì ID |
| invited_at | TIMESTAMP | NOT NULL | ì´ˆëŒ€ ì¼ì‹œ |
| accepted_at | TIMESTAMP | NULLABLE | ì´ˆëŒ€ ìˆ˜ë½ ì¼ì‹œ (NULL = ëŒ€ê¸° ì¤‘) |
| created_at | TIMESTAMP | NOT NULL | ìƒì„± ì¼ì‹œ |
| updated_at | TIMESTAMP | NOT NULL | ìˆ˜ì • ì¼ì‹œ |

**ì œì•½ì¡°ê±´**:
- UNIQUE(repository_id, user_id) - ê°™ì€ ì‚¬ìš©ìëŠ” í•œ Repositoryì— í•œ ë²ˆë§Œ ë“±ë¡
- CHECK(role IN ('owner', 'editor'))
- OwnerëŠ” invited_byê°€ NULLì´ê³  accepted_atì´ ìƒì„± ì‹œì ê³¼ ë™ì¼

**ì¸ë±ìŠ¤**:
- `idx_members_repository_id` ON repository_id
- `idx_members_user_id` ON user_id
- `idx_members_role` ON role
- `idx_members_accepted` ON accepted_at (ì´ˆëŒ€ ëŒ€ê¸° ì¤‘ì¸ ë©¤ë²„ ì¡°íšŒ)

**CASCADE ì •ì±…**:
- Repository ì‚­ì œ ì‹œ: repository_membersë„ ì‚­ì œ (CASCADE)
- User ì‚­ì œ ì‹œ: repository_membersë„ ì‚­ì œ (CASCADE)

**ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**:
- Repository ìƒì„± ì‹œ ìë™ìœ¼ë¡œ Owner ë©¤ë²„ ìƒì„±
- OwnerëŠ” Repositoryë‹¹ 1ëª…ë§Œ ì¡´ì¬ (user_id = repositories.user_id)
- EditorëŠ” ë¬´ì œí•œ
- Private Repositoryë§Œ ë©¤ë²„ ì´ˆëŒ€ ê°€ëŠ¥
- ì´ˆëŒ€ ìˆ˜ë½ ì „ê¹Œì§€ Repository ì ‘ê·¼ ë¶ˆê°€
- Sub-repositoryëŠ” ë¶€ëª¨ Repositoryì˜ ë©¤ë²„ ê¶Œí•œ ìƒì†

**ì˜ˆì œ ë°ì´í„°**:
```sql
-- Owner (Repository ìƒì„±ì)
INSERT INTO repository_members (id, repository_id, user_id, role, invited_at, accepted_at) VALUES
('a50e8400-e29b-41d4-a716-446655440010',
 '650e8400-e29b-41d4-a716-446655440001',
 '550e8400-e29b-41d4-a716-446655440000',
 'owner',
 CURRENT_TIMESTAMP,
 CURRENT_TIMESTAMP);

-- Editor (ì´ˆëŒ€ë°›ì€ ë©¤ë²„, ìˆ˜ë½ ì™„ë£Œ)
INSERT INTO repository_members (id, repository_id, user_id, role, invited_by, invited_at, accepted_at) VALUES
('b50e8400-e29b-41d4-a716-446655440011',
 '650e8400-e29b-41d4-a716-446655440001',
 '650e8400-e29b-41d4-a716-446655440002',
 'editor',
 '550e8400-e29b-41d4-a716-446655440000',
 CURRENT_TIMESTAMP,
 CURRENT_TIMESTAMP);

-- Editor (ì´ˆëŒ€ë°›ì€ ë©¤ë²„, ëŒ€ê¸° ì¤‘)
INSERT INTO repository_members (id, repository_id, user_id, role, invited_by, invited_at, accepted_at) VALUES
('c50e8400-e29b-41d4-a716-446655440012',
 '650e8400-e29b-41d4-a716-446655440001',
 '750e8400-e29b-41d4-a716-446655440003',
 'editor',
 '550e8400-e29b-41d4-a716-446655440000',
 CURRENT_TIMESTAMP,
 NULL);
```

---

## 4. ì¸ë±ìŠ¤ ì „ëµ

### 4.1 ì¡°íšŒ ì„±ëŠ¥ ìµœì í™”
```sql
-- ì‚¬ìš©ìì˜ Repository ëª©ë¡ ì¡°íšŒ
CREATE INDEX idx_repos_user_position
ON repositories(user_id, position)
WHERE deleted_at IS NULL;

-- Repositoryì˜ Document ëª©ë¡ ì¡°íšŒ
CREATE INDEX idx_docs_repo_position
ON documents(repository_id, position)
WHERE deleted_at IS NULL;

-- Public Repository íƒìƒ‰
CREATE INDEX idx_repos_public_created
ON repositories(is_public, created_at DESC)
WHERE deleted_at IS NULL AND is_public = TRUE;
```

### 4.2 ë³µí•© ì¸ë±ìŠ¤
```sql
-- ê²€ìƒ‰ + í•„í„°ë§
CREATE INDEX idx_docs_search_filter
ON documents(repository_id, created_at DESC, deleted_at);

-- íƒœê·¸ í•„í„°ë§
CREATE INDEX idx_doc_tags_filter
ON document_tags(tag_id, document_id);

-- Repository ë©¤ë²„ ì¡°íšŒ (ì‚¬ìš©ìê°€ ì†í•œ Repository ì°¾ê¸°)
CREATE INDEX idx_members_user_accepted
ON repository_members(user_id, accepted_at)
WHERE accepted_at IS NOT NULL;

-- Repository ì´ˆëŒ€ ëŒ€ê¸° ì¤‘ì¸ ë©¤ë²„ ì¡°íšŒ
CREATE INDEX idx_members_pending
ON repository_members(user_id)
WHERE accepted_at IS NULL;
```

---

## 5. ë°ì´í„° ì œì•½ì‚¬í•­

### 5.1 ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™ ì œì•½
```sql
-- 1. Repository ì´ë¦„ ê¸¸ì´ ì œí•œ
ALTER TABLE repositories
ADD CONSTRAINT check_name_length
CHECK (char_length(name) >= 1 AND char_length(name) <= 100);

-- 2. URL í˜•ì‹ ê²€ì¦ (ê¸°ë³¸ì ì¸ ì²´í¬)
ALTER TABLE documents
ADD CONSTRAINT check_url_format
CHECK (url ~* '^https?://');

-- 3. ì´ë©”ì¼ í˜•ì‹ ê²€ì¦
ALTER TABLE users
ADD CONSTRAINT check_email_format
CHECK (email ~* '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$');

-- 4. íƒœê·¸ ì´ë¦„ ì œì•½
ALTER TABLE tags
ADD CONSTRAINT check_tag_name
CHECK (char_length(name) >= 1 AND char_length(name) <= 50);
```

### 5.2 Soft Delete êµ¬í˜„
```sql
-- Soft Deleteë¥¼ ìœ„í•œ ë·° ìƒì„± (deleted_atì´ NULLì¸ ê²ƒë§Œ)
CREATE VIEW active_repositories AS
SELECT * FROM repositories WHERE deleted_at IS NULL;

CREATE VIEW active_documents AS
SELECT * FROM documents WHERE deleted_at IS NULL;
```

### 5.3 ê³„ì¸µ êµ¬ì¡° ì œì•½
```sql
-- Sub-repositoryì˜ ìµœëŒ€ ê¹Šì´ ì œí•œ (5ë‹¨ê³„)
-- ì¬ê·€ CTEë¡œ ê¹Šì´ ì²´í¬í•˜ëŠ” í•¨ìˆ˜
CREATE OR REPLACE FUNCTION check_repository_depth()
RETURNS TRIGGER AS $$
DECLARE
  depth INTEGER;
BEGIN
  WITH RECURSIVE repo_tree AS (
    SELECT id, parent_id, 1 as level
    FROM repositories
    WHERE id = NEW.id

    UNION ALL

    SELECT r.id, r.parent_id, rt.level + 1
    FROM repositories r
    INNER JOIN repo_tree rt ON r.id = rt.parent_id
  )
  SELECT MAX(level) INTO depth FROM repo_tree;

  IF depth > 5 THEN
    RAISE EXCEPTION 'Repository depth cannot exceed 5 levels';
  END IF;

  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER check_depth_before_insert
BEFORE INSERT OR UPDATE ON repositories
FOR EACH ROW EXECUTE FUNCTION check_repository_depth();
```

---

## 6. ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ ì „ëµ

### 6.1 ì´ˆê¸° ë§ˆì´ê·¸ë ˆì´ì…˜ ìˆœì„œ
1. users í…Œì´ë¸” ìƒì„±
2. oauth_accounts í…Œì´ë¸” ìƒì„±
3. repositories í…Œì´ë¸” ìƒì„±
4. repository_members í…Œì´ë¸” ìƒì„±
5. documents í…Œì´ë¸” ìƒì„±
6. tags í…Œì´ë¸” ìƒì„±
7. document_tags í…Œì´ë¸” ìƒì„±
8. repository_shares í…Œì´ë¸” ìƒì„±
9. repository_stats í…Œì´ë¸” ìƒì„±
10. ì¸ë±ìŠ¤ ìƒì„±
11. íŠ¸ë¦¬ê±° ë° ì œì•½ì¡°ê±´ ìƒì„±

### 6.2 ì‹œë“œ ë°ì´í„°
```sql
-- ê°œë°œ í™˜ê²½ìš© ìƒ˜í”Œ ì‚¬ìš©ì
INSERT INTO users (id, email, username, name, email_verified) VALUES
('550e8400-e29b-41d4-a716-446655440000', 'demo@linktoss.com', 'demo', 'Demo User', true);

-- ìƒ˜í”Œ Repository
INSERT INTO repositories (id, user_id, name, description, is_public, slug) VALUES
('650e8400-e29b-41d4-a716-446655440001',
 '550e8400-e29b-41d4-a716-446655440000',
 'My First Repository',
 'Welcome to LinkToss!',
 false,
 'my-first-repository');
```

---

## 7. ë°±ì—… ë° ë³µêµ¬ ì „ëµ

### 7.1 ë°±ì—… ì •ì±…
- **Full Backup**: ë§¤ì¼ 1íšŒ (ìƒˆë²½ 2ì‹œ)
- **Incremental Backup**: 6ì‹œê°„ë§ˆë‹¤
- **ë³´ê´€ ê¸°ê°„**: 30ì¼

### 7.2 ì¤‘ìš” ë°ì´í„° ìš°ì„ ìˆœìœ„
1. users (ìµœìš°ì„ )
2. repositories
3. documents
4. tags, document_tags
5. repository_stats (ì¬ìƒì„± ê°€ëŠ¥)

---

## 8. ì„±ëŠ¥ ê³ ë ¤ì‚¬í•­

### 8.1 íŒŒí‹°ì…”ë‹
- documents í…Œì´ë¸”: created_at ê¸°ì¤€ ì›”ë³„ íŒŒí‹°ì…”ë‹ (ì„ íƒì )
- ë°ì´í„° ì¦ê°€ ì‹œ ì ìš© ê²€í† 

### 8.2 ìºì‹± ì „ëµ
- **Redis ìºì‹œ**:
  - Repository ëª©ë¡: TTL 5ë¶„
  - Document ìƒì„¸: TTL 10ë¶„
  - Public Repository ëª©ë¡: TTL 30ë¶„
  - ì‚¬ìš©ì í†µê³„: TTL 1ì‹œê°„

### 8.3 ì½ê¸° ì„±ëŠ¥ ìµœì í™”
```sql
-- Repository with document count (Materialized View)
CREATE MATERIALIZED VIEW repository_with_counts AS
SELECT
  r.*,
  COUNT(d.id) as document_count
FROM repositories r
LEFT JOIN documents d ON d.repository_id = r.id AND d.deleted_at IS NULL
WHERE r.deleted_at IS NULL
GROUP BY r.id;

-- ì¸ë±ìŠ¤
CREATE INDEX idx_repo_counts_user ON repository_with_counts(user_id);

-- ì£¼ê¸°ì ìœ¼ë¡œ ë¦¬í”„ë ˆì‹œ (cron job)
REFRESH MATERIALIZED VIEW CONCURRENTLY repository_with_counts;
```

---

## 9. ë³´ì•ˆ ê³ ë ¤ì‚¬í•­

### 9.1 ë¯¼ê° ë°ì´í„° ì•”í˜¸í™”
```sql
-- PostgreSQL pgcrypto í™•ì¥ ì‚¬ìš©
CREATE EXTENSION IF NOT EXISTS pgcrypto;

-- OAuth í† í° ì•”í˜¸í™” ì €ì¥
-- ì• í”Œë¦¬ì¼€ì´ì…˜ ë ˆë²¨ì—ì„œ ì•”í˜¸í™” í›„ ì €ì¥
```

### 9.2 Row Level Security (RLS)
```sql
-- Repository ì ‘ê·¼ ê¶Œí•œ: Owner, ë©¤ë²„, ë˜ëŠ” Public
ALTER TABLE repositories ENABLE ROW LEVEL SECURITY;

CREATE POLICY repository_access_policy ON repositories
  FOR ALL
  TO authenticated_users
  USING (
    user_id = current_user_id() OR
    is_public = TRUE OR
    EXISTS (
      SELECT 1 FROM repository_members
      WHERE repository_id = repositories.id
        AND user_id = current_user_id()
        AND accepted_at IS NOT NULL
    )
  );

-- Document ì ‘ê·¼ ê¶Œí•œ: Repository ë©¤ë²„ë§Œ
ALTER TABLE documents ENABLE ROW LEVEL SECURITY;

CREATE POLICY document_access_policy ON documents
  FOR ALL
  TO authenticated_users
  USING (
    EXISTS (
      SELECT 1 FROM repositories r
      LEFT JOIN repository_members rm ON rm.repository_id = r.id
      WHERE r.id = documents.repository_id
        AND (
          r.user_id = current_user_id() OR
          r.is_public = TRUE OR
          (rm.user_id = current_user_id() AND rm.accepted_at IS NOT NULL)
        )
    )
  );
```

---

## 10. ë³€ê²½ ì´ë ¥

| ë‚ ì§œ | ë²„ì „ | ë³€ê²½ ë‚´ìš© | ì‘ì„±ì |
|------|------|-----------|--------|
| 2025-10-10 | 1.0 | ì´ˆê¸° ì‘ì„± | Engineering Team |
| 2025-10-10 | 1.1 | repository_members í…Œì´ë¸” ì¶”ê°€ (í˜‘ì—… ê¸°ëŠ¥), password_hash ì œê±° (ì†Œì…œ ë¡œê·¸ì¸ ì „ìš©), RLS ì •ì±… ì—…ë°ì´íŠ¸ | Engineering Team |

---

## ë¶€ë¡ A: SQL ìŠ¤í‚¤ë§ˆ ì „ì²´ ì½”ë“œ

```sql
-- UUID í™•ì¥ í™œì„±í™”
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- users í…Œì´ë¸” (ì†Œì…œ ë¡œê·¸ì¸ ì „ìš©, password_hash ì œê±°)
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  email VARCHAR(255) UNIQUE NOT NULL,
  username VARCHAR(50) UNIQUE NOT NULL,
  name VARCHAR(100) NOT NULL,
  avatar_url VARCHAR(500),
  bio TEXT,
  email_verified BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  deleted_at TIMESTAMP WITH TIME ZONE
);

-- oauth_accounts í…Œì´ë¸”
CREATE TABLE oauth_accounts (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  provider VARCHAR(50) NOT NULL,
  provider_account_id VARCHAR(255) NOT NULL,
  access_token TEXT,
  refresh_token TEXT,
  expires_at TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(provider, provider_account_id)
);

-- repositories í…Œì´ë¸”
CREATE TABLE repositories (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  parent_id UUID REFERENCES repositories(id) ON DELETE CASCADE,
  name VARCHAR(100) NOT NULL,
  description TEXT,
  icon VARCHAR(10) DEFAULT 'ğŸ“',
  is_public BOOLEAN DEFAULT FALSE,
  slug VARCHAR(100) NOT NULL,
  position INTEGER DEFAULT 0,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  deleted_at TIMESTAMP WITH TIME ZONE,
  UNIQUE(user_id, slug)
);

-- documents í…Œì´ë¸”
CREATE TABLE documents (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  repository_id UUID NOT NULL REFERENCES repositories(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  title VARCHAR(500) NOT NULL,
  url TEXT NOT NULL,
  content TEXT,
  link_metadata JSONB,
  position INTEGER DEFAULT 0,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  deleted_at TIMESTAMP WITH TIME ZONE
);

-- tags í…Œì´ë¸”
CREATE TABLE tags (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  name VARCHAR(50) NOT NULL,
  color VARCHAR(7) DEFAULT '#3B82F6',
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(user_id, name)
);

-- document_tags í…Œì´ë¸”
CREATE TABLE document_tags (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  document_id UUID NOT NULL REFERENCES documents(id) ON DELETE CASCADE,
  tag_id UUID NOT NULL REFERENCES tags(id) ON DELETE CASCADE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(document_id, tag_id)
);

-- repository_shares í…Œì´ë¸”
CREATE TABLE repository_shares (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  repository_id UUID NOT NULL REFERENCES repositories(id) ON DELETE CASCADE,
  share_token VARCHAR(100) UNIQUE NOT NULL,
  view_count INTEGER DEFAULT 0,
  expires_at TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- repository_stats í…Œì´ë¸”
CREATE TABLE repository_stats (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  repository_id UUID UNIQUE NOT NULL REFERENCES repositories(id) ON DELETE CASCADE,
  document_count INTEGER DEFAULT 0,
  view_count INTEGER DEFAULT 0,
  share_count INTEGER DEFAULT 0,
  last_accessed_at TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- repository_members í…Œì´ë¸” (í˜‘ì—… ê¸°ëŠ¥)
CREATE TABLE repository_members (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  repository_id UUID NOT NULL REFERENCES repositories(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  role VARCHAR(20) NOT NULL CHECK (role IN ('owner', 'editor')),
  invited_by UUID REFERENCES users(id) ON DELETE SET NULL,
  invited_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
  accepted_at TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(repository_id, user_id)
);

-- ì¸ë±ìŠ¤ ìƒì„±
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_repos_user_id ON repositories(user_id);
CREATE INDEX idx_repos_parent_id ON repositories(parent_id);
CREATE INDEX idx_docs_repository_id ON documents(repository_id);
CREATE INDEX idx_docs_user_id ON documents(user_id);
CREATE INDEX idx_tags_user_id ON tags(user_id);
CREATE INDEX idx_doc_tags_document_id ON document_tags(document_id);
CREATE INDEX idx_doc_tags_tag_id ON document_tags(tag_id);
CREATE INDEX idx_members_repository_id ON repository_members(repository_id);
CREATE INDEX idx_members_user_id ON repository_members(user_id);
CREATE INDEX idx_members_role ON repository_members(role);

-- updated_at ìë™ ì—…ë°ì´íŠ¸ íŠ¸ë¦¬ê±° í•¨ìˆ˜
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = CURRENT_TIMESTAMP;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- ê° í…Œì´ë¸”ì— íŠ¸ë¦¬ê±° ì ìš©
CREATE TRIGGER update_users_updated_at BEFORE UPDATE ON users
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
CREATE TRIGGER update_repositories_updated_at BEFORE UPDATE ON repositories
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
CREATE TRIGGER update_documents_updated_at BEFORE UPDATE ON documents
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
CREATE TRIGGER update_repository_members_updated_at BEFORE UPDATE ON repository_members
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- Repository ìƒì„± ì‹œ Owner ë©¤ë²„ ìë™ ìƒì„± íŠ¸ë¦¬ê±°
CREATE OR REPLACE FUNCTION create_repository_owner()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO repository_members (repository_id, user_id, role, invited_at, accepted_at)
  VALUES (NEW.id, NEW.user_id, 'owner', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP);
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER create_owner_after_repository_insert
AFTER INSERT ON repositories
FOR EACH ROW EXECUTE FUNCTION create_repository_owner();
```
